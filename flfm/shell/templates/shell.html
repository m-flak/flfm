{% extends "base.html" %}
{% import "bootstrap/utils.html" as utils %}
{% import "links.html" as links %}

{% block styles -%}
{{ super() }}
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/filepond@4.5.0/dist/filepond.min.css" />
{%- endblock %}

{% block body -%}
<div id="layout">
 <div class="container">
  <div class="fl-row">
      <div class="card full-card clear-card j-center">
          <h1>Flask File Manager</h1>
      </div>
  </div>
  {% set flashies = get_flashed_messages(with_categories=True) -%}
  {%- if flashies|length() > 0 %}
  <div class="fl-row">
      {{ utils.flashed_messages(messages=flashies) }}
  </div>
  {% endif -%}
  <div class="fl-row">
      <div id="location-bar" class="card full-card card-shadow j-center">
          <h4>{{ whereami }}</h4>
          <div id="commands">
              <ul>
                  <li>
                      <a id="buttonUp" class="btn btn-primary" href="#" role="button" title="Go Up...">
                          &#x2191;
                      </a>
                  </li>
                  <li>
                      <a class="btn btn-primary fl-settings" href="#" role="button" title="Settings..." data-toggle="modal" data-target="#settingsModal">
                          <img src="{{ url_for('static', filename='flfm_settings.gif') }}" />
                      </a>
                  </li>
                  <li>
                      <a class="btn btn-primary" id="buttonUpload" href="#" role="button" title="Upload File..." data-toggle="modal" data-target="#uploadModal">
                          Upload
                      </a>
                  </li>
              </ul>
          </div>
      </div>
  </div>
  <div class="fl-row">
      <div class="card full-card card-shadow j-center">
          {%- if folder_contents|length() != 0 %}
          <table class="directory-list">
          <thead>
              <tr>
                  <th id="header-contents" colspan="2">Contents</th>
                  <th id="header-size" colspan="1">Size <i>(in bytes)</i></th>
              </tr>
          </thead>
          <tbody>
          {%- for content in folder_contents %}
            <tr>
                <td>
                {%- if content.file %}
                <img src="{{ url_for('static', filename='flfm_file.gif') }}"
                    alt="File" title="File" />
                {% elif content.directory %}
                <img src="{{ url_for('static', filename='flfm_folder.gif') }}"
                    alt="Directory" title="Directory" />
                {% endif -%}
                </td>
                <td>
                    {%- if content.directory %}
                        {% set paragraph_caption -%}
                            <p>{{ content.name }}</p>
                        {%- endset %}
                        {{ links.shell_path_link('shell.shell_view', content.uri_path, paragraph_caption, False) }}
                    {%- else -%}
                        {% set paragraph_caption -%}
                            <p>{{ content.name }}</p>
                        {%- endset %}
                        {{ links.shell_file_link('shell.serve_file', content.path, paragraph_caption) }}
                    {% endif -%}
                </td>
                <td>
                    <p>{{ content.size }}</p>
                </td>
            </tr>
          {% endfor -%}
          </tbody>
          </table>
          {%- else %}
          <p class="nothing-here">There's nothing here...</p>
          {% endif -%}
      </div>
  </div>
 </div>
</div>
<div class="modal fade" id="uploadModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadModalLabel">Upload File</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="uploadModalAlerts">
                </div>
                <input type="file" class="filepond" name="filepond" data-max-files="1" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    Close
                </button>
                <button type="button" id="uploadModalFinishButton" class="btn btn-primary" data-dismiss="modal">Finish</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="settingsModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <img src="{{ url_for('static', filename='flfm_settings.gif') }}" />
                    <h5 class="modal-title">Settings</h5>
                </div>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <h5>Built-in Viewer:</h5>
                <p>Whether or not you wish to enable the built-in viewer for
                    text files.
                </p>
                <form id="settingsModalForm-1">
                    <input type="radio" name="viewer" id="viewerDisabled" value="disabled" />
                    <label for="viewerDisabled">Disabled</label>
                    <br/>
                    <input type="radio" name="viewer" id="viewerEnabled" value="enabled" />
                    <label for="viewerEnabled">Enabled</label>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    Close
                </button>
                <button type="button" id="settingsModalApplyButton" class="btn btn-primary" data-dismiss="modal">Apply</button>
            </div>
        </div>
    </div>
</div>
{{ super() }}
{%- endblock %}

{% block scripts -%}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/js-cookie@2.2.1/src/js.cookie.min.js"></script>
{%- if cwd_mapping.dir_allowuploads %}
<script src="//cdn.jsdelivr.net/npm/filepond@4.5.0/dist/filepond.min.js"></script>
<script type="text/javascript">
    /*<!CDATA[*/
    function make_error_alert(error_string) {
        $("#uploadModalAlerts").append(`<div class='alert alert-danger' role='alert'>${error_string}</div>`);
    }
    var fp_object = null;
    var ul_finished = false;
    $("a#buttonUp").on("click", function() {
        var new_url = window.location.href.replace(/(?!\/shell)\/\w+(?:[%1-9]*\w*)*#?$/, '');
        document.location.assign(new_url);
    });
    $("#uploadModal").on("show.bs.modal", function(e) {
        let file_input = $(e.currentTarget).find("input[type='file']").get(0);
        $(e.currentTarget).find("button#uploadModalFinishButton").attr('disabled', true);
        if (!fp_object) {
            fp_object = FilePond.create(file_input);
        }
        let wl = window.location;
        fp_object.setOptions({
            allowPaste: false,
            allowReplace: false,
            allowRevert: false,
            server: {
                url: `${wl.protocol}//${wl.host}`,
                process: {
                    url: '/process',
                    method: 'POST',
                    headers: {
                        'X-Uploadto': "{{ whereami }}"
                    },
                },
            },
            onprocessfile: function(err,file) {
                if (!err) {
                    var serverid = file.serverId;
                    var ul_dir = "{{ whereami }}";
                    $.ajax({
                        method: 'POST',
                        url: `${wl.protocol}//${wl.host}/process`,
                        data: { id: serverid },
                        dataType: 'text'
                    }).done(function(d) {
                        if (d === 'SUCCESS') {
                            let bt_fin = $("#uploadModal").find("button#uploadModalFinishButton");
                            bt_fin.attr('disabled', false);
                        } else if (d === 'EXISTS') {
                            make_error_alert("File already exists on server!");
                        } else if (d === 'NOUPLOAD') {
                            make_error_alert("File failed to be uploaded!");
                        }
                    });
                }
            },
        });
    });
    $("#uploadModal").find("div.modal-footer").children("button").on("click", function(e) {
        var tc = e.currentTarget.textContent.trim();
        if (tc === 'Finish') {
            ul_finished = true;
        }
    });
    $("#uploadModal").on("hidden.bs.modal", function (e) {
        let file_input = $(e.currentTarget).find("input[type='file']").get(0);
        $(e.currentTarget).find("button#uploadModalFinishButton").attr('disabled', false);
        if (fp_object) {
            fp_object.destroy(file_input);
            delete fp_object;
            fp_object = null;
        }
        let alerts = $("#uploadModalAlerts").children();
        if (alerts.length > 0) {
            alerts.each(function() {
                $(this).remove();
            });
        }
        if (ul_finished) {
            ul_finished = false;
            window.location.reload(true);
        }
    });
    $("#settingsModal").on("show.bs.modal", function(e) {
        var cookie = Cookies.get('flfm_viewer');
        if (cookie != null) {
            let vform = $(e.currentTarget).find("form#settingsModalForm-1").get(0);
            for (var i = 0; i < vform.elements.length; i++) {
                if (vform.elements[i].value === cookie) {
                    vform.elements[i].checked = true;
                }
            }
        }
    });
    $("#settingsModalApplyButton").on("click", function() {
        let vform = $("#settingsModal").find("form#settingsModalForm-1").get(0);
        var viewer_new_val = null;
        for (var i = 0; i < vform.elements.length; i++) {
            if (vform.elements[i].checked == true) {
                viewer_new_val = vform.elements[i].value;
            }
        }
        if (!viewer_new_val) {
            return;
        }
        if (Cookies.get('flfm_viewer') != null) {
            Cookies.remove('flfm_viewer');
        }
        Cookies.set('flfm_viewer', viewer_new_val);
    });
    //]]>
</script>
{%- else -%}
<script type="text/javascript">
    /*<!CDATA[*/
    $("a#buttonUp").on("click", function() {
        var new_url = window.location.href.replace(/(?!\/shell)\/\w+(?:[%1-9]*\w*)*#?$/, '');
        document.location.assign(new_url);
    });
    $("a#buttonUpload").addClass('disabled');
    $("#settingsModal").on("show.bs.modal", function(e) {
        var cookie = Cookies.get('flfm_viewer');
        if (cookie != null) {
            let vform = $(e.currentTarget).find("form#settingsModalForm-1").get(0);
            for (var i = 0; i < vform.elements.length; i++) {
                if (vform.elements[i].value === cookie) {
                    vform.elements[i].checked = true;
                }
            }
        }
    });
    $("#settingsModalApplyButton").on("click", function() {
        let vform = $("#settingsModal").find("form#settingsModalForm-1").get(0);
        var viewer_new_val = null;
        for (var i = 0; i < vform.elements.length; i++) {
            if (vform.elements[i].checked == true) {
                viewer_new_val = vform.elements[i].value;
            }
        }
        if (!viewer_new_val) {
            return;
        }
        if (Cookies.get('flfm_viewer') != null) {
            Cookies.remove('flfm_viewer');
        }
        Cookies.set('flfm_viewer', viewer_new_val);
    });
    //]]>
</script>
{% endif -%}
{%- endblock %}
